"use strict";(self.webpackChunksmil_infra_user_manual=self.webpackChunksmil_infra_user_manual||[]).push([[313],{7385:(e,t,a)=>{a.r(t),a.d(t,{default:()=>g});var s=a(6252),r=a(3577);const n={key:0},l={data:()=>({rate:null}),methods:{async queryUsage(){this.loading=!0;const e=new URL("https://prometheus.scut-smil.cn/api/v1/query");e.searchParams.set("query","max(ceph_osd_stat_bytes_used / ceph_osd_stat_bytes)");try{const t=await fetch(e),a=await t.json();this.rate=parseFloat(a.data.result[0].value[1])}catch(e){}}},computed:{rateDisplay(){return(100*this.rate).toFixed(1)}},created(){this.queryUsage()}},c=(0,a(3744).Z)(l,[["render",function(e,t,a,l,c,d){return null!==c.rate?((0,s.wg)(),(0,s.iD)("p",n," 当前最高的硬盘使用率："+(0,r.zw)(d.rateDisplay)+"% ",1)):(0,s.kq)("",!0)}]]),d=(0,s._)("h1",{id:"清理cephfs存储空间",tabindex:"-1"},[(0,s._)("a",{class:"header-anchor",href:"#清理cephfs存储空间","aria-hidden":"true"},"#"),(0,s.Uk)(" 清理CephFS存储空间")],-1),u=(0,s._)("p",null,[(0,s.Uk)("为了CephFS存储可以时刻运行在高效状态，请给位用户"),(0,s._)("strong",null,"及时清理CephFS上home目录的数据！！！")],-1),i=(0,s._)("p",null,[(0,s.Uk)("当集群中有任意一块硬盘的使用率达到89%时，集群会进入NEARFULL状态。在该状态下，CephFS上的写入操作将不会使用buffer，"),(0,s._)("strong",null,"导致写入性能严重下降"),(0,s.Uk)("，以及集群负载的上升。")],-1),o=(0,s._)("p",null,[(0,s.Uk)("而当任意一块硬盘的使用率达到95%时集群将进入FULL状态，"),(0,s._)("strong",null,"不再接受写入请求"),(0,s.Uk)("。")],-1),p={href:"https://prometheus.scut-smil.cn/graph?g0.expr=ceph_osd_stat_bytes_used%2Fceph_osd_stat_bytes",target:"_blank",rel:"noopener noreferrer"},h=(0,s.Uk)("当前各硬盘使用率"),m=(0,s.uE)('<h2 id="如何查看各目录空间大小" tabindex="-1"><a class="header-anchor" href="#如何查看各目录空间大小" aria-hidden="true">#</a> 如何查看各目录空间大小？</h2><p>由于CephFS的分布式缓存的特性，请尽量避免在文件数量较多（&gt;10万）的文件夹中使用<code>du</code>/<code>ncdu</code>等需要遍历所有文件的命令，否则会<strong>极大影响CephFS存储在所有服务器上的性能</strong>。</p><p>推荐使用<code>cephdu</code>工具查看目录大小。其安装方式如下：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>pip install cephdu\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>其一般的使用方式如下：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cephdu -d 1 -h /mnt/mixed/dataset | sort -h\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p><code>cephdu</code>借助cephfs的特性，可在O(1)时间复杂度内返回结果。</p><p>也可使用<code>getfattr</code>命令查询目录大小和其中的文件数量，可以参考以下命令：</p><ul><li>文件夹中文件总大小：<code>getfattr -n ceph.dir.rbytes /PATH/TO/DIR-IN-CEPHFS</code></li><li>文件夹中文件总文件数量：<code>getfattr -n ceph.dir.rfiles /PATH/TO/DIR-IN-CEPHFS</code></li></ul>',9),g={setup:e=>(e,t)=>{const a=(0,s.up)("OutboundLink");return(0,s.wg)(),(0,s.iD)(s.HY,null,[d,u,i,o,(0,s._)("p",null,[(0,s._)("a",p,[h,(0,s.Wm)(a)])]),(0,s.Wm)(c),m],64)}}},4455:(e,t,a)=>{a.r(t),a.d(t,{data:()=>s});const s={key:"v-2fd63c42",path:"/storage/cleanup.html",title:"清理CephFS存储空间",lang:"zh-CN",frontmatter:{},excerpt:"",headers:[{level:2,title:"如何查看各目录空间大小？",slug:"如何查看各目录空间大小",children:[]}],filePathRelative:"storage/cleanup.md",git:{updatedTime:1655566735e3,contributors:[{name:"胡玮文",email:"huww98@outlook.com",commits:3},{name:"chenyaofo",email:"chenyaofo@gmail.com",commits:1},{name:"胡玮文",email:"huww98@163.com",commits:1}]}}}}]);