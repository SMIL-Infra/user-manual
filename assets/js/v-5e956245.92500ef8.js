"use strict";(self.webpackChunksmil_infra_user_manual=self.webpackChunksmil_infra_user_manual||[]).push([[129],{4794:(n,a,s)=>{s.r(a),s.d(a,{default:()=>P});var e=s(6252);const c=(0,e._)("h1",{id:"编译cuda代码",tabindex:"-1"},[(0,e._)("a",{class:"header-anchor",href:"#编译cuda代码","aria-hidden":"true"},"#"),(0,e.Uk)(" 编译CUDA代码")],-1),l=(0,e._)("p",null,"在安装一些依赖，或者编译其他CUDA代码时，需要使用NVIDIA发布的编译器nvcc，但该软件不太容易安装。因此我们提供了全局安装，方便大家使用。",-1),t=(0,e.Uk)("在使用时，在安装其他软件或编译前，先执行以下以下命令以设置环境变量（"),p={href:"https://docs.nvidia.com/cuda/cuda-installation-guide-linux/index.html#environment-setup",target:"_blank",rel:"noopener noreferrer"},i=(0,e.Uk)("参考NVIDIA文档"),r=(0,e.Uk)("）："),o=(0,e.uE)('<div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 在下列几行中选择一个版本</span>\n<span class="token comment"># export CUDA_HOME=/mnt/cephfs/smil/cuda/cuda-9.0</span>\n<span class="token comment"># export CUDA_HOME=/mnt/cephfs/smil/cuda/cuda-9.2</span>\n<span class="token comment"># export CUDA_HOME=/mnt/cephfs/smil/cuda/cuda-10.0</span>\n<span class="token comment"># export CUDA_HOME=/mnt/cephfs/smil/cuda/cuda-10.1</span>\n<span class="token builtin class-name">export</span> <span class="token assign-left variable">CUDA_HOME</span><span class="token operator">=</span>/mnt/cephfs/smil/cuda/cuda-10.2\n<span class="token comment"># export CUDA_HOME=/mnt/cephfs/smil/cuda/cuda-11.0</span>\n<span class="token comment"># export CUDA_HOME=/mnt/cephfs/smil/cuda/cuda-11.1</span>\n\n<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token variable">${CUDA_HOME}</span>/bin<span class="token variable">${<span class="token environment constant">PATH</span><span class="token operator">:+</span><span class="token operator">:</span>${<span class="token environment constant">PATH</span>}</span><span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="custom-container tip"><p class="custom-container-title">提示</p><p>实验室的服务器上默认的gcc版本是9，而CUDA 11之前的版本并不支持这么高的gcc的版本，会导致编译错误：</p><div class="language-text ext-text"><pre class="language-text"><code>unsupported GNU version! gcc versions later than 7 are not supported!\n</code></pre></div><p>这时可以通过以下环境变量更改默认的gcc版本：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">CC</span><span class="token operator">=</span>gcc-7 <span class="token assign-left variable">CXX</span><span class="token operator">=</span>g++-7\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>然后删除各种编译缓存并重试。若还是不行，则通过以下方式更改PATH中的gcc</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">ln</span> -s /usr/bin/gcc-7 ~/.local/bin/gcc <span class="token comment"># 若~/.local/bin不存在，则先运行mkdir -p ~/.local/bin，然后重新登录</span>\n<span class="token function">ln</span> -s /usr/bin/g++-7 ~/.local/bin/g++\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>然后运行<code>gcc -v</code>命令确认现在默认的gcc版本是7，再重试安装过程。</p><p>完成后，若要恢复默认使用新版gcc，则需手动删除上面创建的<code>~/.local/bin/</code>中的两个文件</p></div><div class="custom-container warning"><p class="custom-container-title">注意</p><p>在选择版本时，请保持CUDA_HOME引用的版本和其他库使用的版本一致，例如pytorch安装时选择的版本。</p></div><div class="custom-container tip"><p class="custom-container-title">提示</p><p>编译好的软件在运行时也需要链接一些动态库。如果你使用pip或conda安装pytorch的话，这些都应该已经自动安装了。但如果出现找不到cuda相关动态链接库的错误，可以尝试从全局安装的目录中加载。添加以下环境变量：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">LD_LIBRARY_PATH</span><span class="token operator">=</span><span class="token variable">${CUDA_HOME}</span>/lib64<span class="token variable">${LD_LIBRARY_PATH<span class="token operator">:+</span><span class="token operator">:</span>${LD_LIBRARY_PATH}</span><span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div></div>',4),u={class:"custom-container tip"},d=(0,e._)("p",{class:"custom-container-title"},"提示",-1),m=(0,e._)("p",null,"实验室不同机器上有新旧不同的多种GPU，而pytorch默认只会为当前系统中的GPU编译。所以在较新的机器上安装的环境在较老的服务器上可能出现无法运行，并有以下报错：",-1),b=(0,e._)("div",{class:"language-text ext-text"},[(0,e._)("pre",{class:"language-text"},[(0,e._)("code",null,"no kernel image is available for execution on the device\n")])],-1),h=(0,e._)("p",null,"在较老的服务器上编译的程序在新服务器上也可能无法发挥出最佳性能。",-1),_=(0,e.Uk)("这时可以参考"),v={href:"https://pytorch.org/docs/stable/cpp_extension.html#torch.utils.cpp_extension.CUDAExtension",target:"_blank",rel:"noopener noreferrer"},k=(0,e.Uk)("pytorch文档"),g=(0,e.Uk)("，在编译安装前手动指定需要支持的计算兼容性版本："),x=(0,e.uE)('<div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">TORCH_CUDA_ARCH_LIST</span><span class="token operator">=</span><span class="token string">&quot;6.1 8.6&quot;</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div>',1),f=(0,e.Uk)("其中的版本号可参考"),A={href:"https://developer.nvidia.com/cuda-gpus#compute",target:"_blank",rel:"noopener noreferrer"},U=(0,e.Uk)("NVIDIA官网"),w=(0,e.Uk)("的表。这里列出的是实验室所用的TITAN X/Xp和RTX 3090，可在实验室所有服务器上运行。"),C=(0,e.uE)('<h2 id="mnt-cephfs-smil-cuda中的软件的安装方法" tabindex="-1"><a class="header-anchor" href="#mnt-cephfs-smil-cuda中的软件的安装方法" aria-hidden="true">#</a> /mnt/cephfs/smil/cuda中的软件的安装方法</h2><p>供大家在排查问题时参考</p><h3 id="cuda-9-0" tabindex="-1"><a class="header-anchor" href="#cuda-9-0" aria-hidden="true">#</a> cuda-9.0</h3><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">wget</span> https://developer.nvidia.com/compute/cuda/9.0/Prod/local_installers/cuda_9.0.176_384.81_linux-run\n<span class="token function">wget</span> https://developer.nvidia.com/compute/cuda/9.0/Prod/patches/4/cuda_9.0.176.1_linux-run\n<span class="token function">wget</span> https://developer.nvidia.com/compute/cuda/9.0/Prod/patches/4/cuda_9.0.176.2_linux-run\n<span class="token function">wget</span> https://developer.nvidia.com/compute/cuda/9.0/Prod/patches/4/cuda_9.0.176.3_linux-run\n<span class="token function">wget</span> https://developer.nvidia.com/compute/cuda/9.0/Prod/patches/4/cuda_9.0.176.4_linux-run\n<span class="token function">chmod</span> +x cuda_*run\n./cuda_9.0.176.1_linux-run --silent --toolkit --toolkitpath<span class="token operator">=</span>/mnt/cephfs/smil/cuda/cuda-9.0/ --override\n./cuda_9.0.176.1_linux-run --silent --installdir<span class="token operator">=</span>/mnt/cephfs/smil/cuda/cuda-9.0/ --accept-eula\n./cuda_9.0.176.2_linux-run --silent --installdir<span class="token operator">=</span>/mnt/cephfs/smil/cuda/cuda-9.0/ --accept-eula\n./cuda_9.0.176.3_linux-run --silent --installdir<span class="token operator">=</span>/mnt/cephfs/smil/cuda/cuda-9.0/ --accept-eula\n./cuda_9.0.176.4_linux-run --silent --installdir<span class="token operator">=</span>/mnt/cephfs/smil/cuda/cuda-9.0/ --accept-eula\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="cuda-10-0" tabindex="-1"><a class="header-anchor" href="#cuda-10-0" aria-hidden="true">#</a> cuda-10.0</h3><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">wget</span> https://developer.nvidia.com/compute/cuda/10.0/Prod/local_installers/cuda_10.0.130_410.48_linux\n<span class="token function">wget</span> http://developer.download.nvidia.com/compute/cuda/10.0/Prod/patches/1/cuda_10.0.130.1_linux.run\n<span class="token function">chmod</span> +x cuda_10.0*\n./cuda_10.0.130_410.48_linux --silent --toolkit --toolkitpath<span class="token operator">=</span>/mnt/cephfs/smil/cuda/cuda-10.0/ --override\n./cuda_10.0.130.1_linux.run --silent --installdir<span class="token operator">=</span>/mnt/cephfs/smil/cuda/cuda-10.0/ --accept-eula\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="cuda-10-1" tabindex="-1"><a class="header-anchor" href="#cuda-10-1" aria-hidden="true">#</a> cuda-10.1</h3><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">wget</span> https://developer.download.nvidia.com/compute/cuda/10.1/Prod/local_installers/cuda_10.1.243_418.87.00_linux.run\n<span class="token function">chmod</span> +x cuda_*.run\n./cuda_10.1.243_418.87.00_linux.run --silent --toolkit --installpath<span class="token operator">=</span>/mnt/cephfs/smil/cuda/cuda-10.1/ --override\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="cuda-10-2" tabindex="-1"><a class="header-anchor" href="#cuda-10-2" aria-hidden="true">#</a> cuda-10.2</h3><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">wget</span> https://developer.download.nvidia.com/compute/cuda/10.2/Prod/local_installers/cuda_10.2.89_440.33.01_linux.run\n<span class="token function">wget</span> https://developer.download.nvidia.com/compute/cuda/10.2/Prod/patches/1/cuda_10.2.1_linux.run\n<span class="token function">wget</span> https://developer.download.nvidia.com/compute/cuda/10.2/Prod/patches/2/cuda_10.2.2_linux.run\n<span class="token function">chmod</span> +x cuda_*.run\n./cuda_10.2.89_440.33.01_linux.run --silent --toolkit --installpath<span class="token operator">=</span>/mnt/cephfs/smil/cuda/cuda-10.2/\n./cuda_10.2.1_linux.run --silent --toolkit --installpath<span class="token operator">=</span>/mnt/cephfs/smil/cuda/cuda-10.2/\n./cuda_10.2.2_linux.run --silent --toolkit --installpath<span class="token operator">=</span>/mnt/cephfs/smil/cuda/cuda-10.2/\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="cuda-11-0" tabindex="-1"><a class="header-anchor" href="#cuda-11-0" aria-hidden="true">#</a> cuda-11.0</h3><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">wget</span> https://developer.download.nvidia.com/compute/cuda/11.0.3/local_installers/cuda_11.0.3_450.51.06_linux.run\n<span class="token function">chmod</span> +x cuda_*.run\n./cuda_11.0.3_450.51.06_linux.run --silent --toolkit --installpath<span class="token operator">=</span>/mnt/cephfs/smil/cuda/cuda-11.0/\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div>',12),D={},P=(0,s(3744).Z)(D,[["render",function(n,a){const s=(0,e.up)("OutboundLink");return(0,e.wg)(),(0,e.iD)(e.HY,null,[c,l,(0,e._)("p",null,[t,(0,e._)("a",p,[i,(0,e.Wm)(s)]),r]),o,(0,e._)("div",u,[d,m,b,h,(0,e._)("p",null,[_,(0,e._)("a",v,[k,(0,e.Wm)(s)]),g]),x,(0,e._)("p",null,[f,(0,e._)("a",A,[U,(0,e.Wm)(s)]),w])]),C],64)}]])},5370:(n,a,s)=>{s.r(a),s.d(a,{data:()=>e});const e={key:"v-5e956245",path:"/guide/nvcc.html",title:"编译CUDA代码",lang:"zh-CN",frontmatter:{},excerpt:"",headers:[{level:2,title:"/mnt/cephfs/smil/cuda中的软件的安装方法",slug:"mnt-cephfs-smil-cuda中的软件的安装方法",children:[{level:3,title:"cuda-9.0",slug:"cuda-9-0",children:[]},{level:3,title:"cuda-10.0",slug:"cuda-10-0",children:[]},{level:3,title:"cuda-10.1",slug:"cuda-10-1",children:[]},{level:3,title:"cuda-10.2",slug:"cuda-10-2",children:[]},{level:3,title:"cuda-11.0",slug:"cuda-11-0",children:[]}]}],filePathRelative:"guide/nvcc.md",git:{updatedTime:1641299235e3,contributors:[{name:"胡玮文",email:"huww98@outlook.com",commits:8}]}}}}]);